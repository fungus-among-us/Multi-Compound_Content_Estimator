<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Deep Space Supernova</title>
  <style>
    body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; }
    #hint {
      position: absolute; bottom: 30px; width: 100%; text-align: center;
      color: #aaa; pointer-events: none; letter-spacing: 2px;
    }
  </style>
  <script type="importmap">
    { "imports": { "three": "https://esm.sh/three@0.160.0", "three/addons/": "https://esm.sh/three@0.160.0/examples/jsm/" } }
  </script>
</head>
<body>
  <div id="hint">CLICK TO DETONATE // SCROLL TO ZOOM</div>

  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";
    import { EffectComposer } from "three/addons/postprocessing/EffectComposer.js";
    import { RenderPass } from "three/addons/postprocessing/RenderPass.js";
    import { UnrealBloomPass } from "three/addons/postprocessing/UnrealBloomPass.js";
    import { OutputPass } from "three/addons/postprocessing/OutputPass.js";

    // --- SETUP ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 30, 60);

    const renderer = new THREE.WebGLRenderer({ antialias: false });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.autoRotate = true;
    controls.autoRotateSpeed = 0.5;

    // --- GALAXY GENERATION ---
    const count = 150000;
    const geo = new THREE.BufferGeometry();
    const pos = new Float32Array(count * 3);
    const col = new Float32Array(count * 3);
    const initialPos = new Float32Array(count * 3); // Store rest position for shader

    const color1 = new THREE.Color(0xff4400); // Red/Orange
    const color2 = new THREE.Color(0x0088ff); // Blue

    for(let i=0; i<count; i++) {
      const i3 = i * 3;
      const r = Math.random() * 30;
      const spin = r * 0.2;
      const branch = (i % 3) * ((Math.PI * 2) / 3);

      const angle = branch + spin + (Math.random()-0.5) * 0.5;

      const x = Math.cos(angle) * r;
      const y = (Math.random()-0.5) * (1 - r/30) * 5; // Flat disc
      const z = Math.sin(angle) * r;

      pos[i3] = x; pos[i3+1] = y; pos[i3+2] = z;
      initialPos[i3] = x; initialPos[i3+1] = y; initialPos[i3+2] = z;

      // Color Mix
      const mixed = color1.clone().lerp(color2, Math.random());
      if(r < 5) mixed.setHex(0xffffff); // Bright center
      col[i3] = mixed.r; col[i3+1] = mixed.g; col[i3+2] = mixed.b;
    }

    geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
    geo.setAttribute('initialPos', new THREE.BufferAttribute(initialPos, 3));
    geo.setAttribute('color', new THREE.BufferAttribute(col, 3));

    // --- SHADER MATERIAL ---
    const material = new THREE.ShaderMaterial({
      uniforms: {
        time: { value: 0 },
        uClickTime: { value: -100.0 },
        pointSize: { value: 2.0 * renderer.getPixelRatio() }
      },
      vertexShader: `
        uniform float time;
        uniform float uClickTime;
        uniform float pointSize;

        attribute vec3 initialPos;
        attribute vec3 color;
        varying vec3 vColor;

        void main() {
          vColor = color;
          vec3 p = initialPos;

          // Gentle rotation
          float angle = time * 0.1;
          float c = cos(angle);
          float s = sin(angle);
          mat2 m = mat2(c, -s, s, c);
          p.xz = m * p.xz;

          // SHOCKWAVE MATH
          float elapsed = time - uClickTime;
          if(elapsed > 0.0) {
             float dist = length(p);
             float waveRadius = elapsed * 40.0; // Expansion speed
             float waveWidth = 10.0;

             // If particle is within the shockwave band
             if(dist < waveRadius && dist > waveRadius - waveWidth) {
                // Displace outward
                vec3 dir = normalize(p);
                float strength = 1.0 - (abs(dist - (waveRadius - waveWidth*0.5)) / (waveWidth*0.5));
                p += dir * strength * 15.0; // Push amount

                // Flash white
                vColor = mix(vColor, vec3(1.0, 1.0, 1.0), strength);
             }
          }

          vec4 mv = modelViewMatrix * vec4(p, 1.0);
          gl_Position = projectionMatrix * mv;
          gl_PointSize = pointSize * (30.0 / -mv.z);
        }
      `,
      fragmentShader: `
        varying vec3 vColor;
        void main() {
          // Circle shape
          float d = length(gl_PointCoord - vec2(0.5));
          if(d > 0.5) discard;

          // Soft edge
          float alpha = 1.0 - smoothstep(0.3, 0.5, d);
          gl_FragColor = vec4(vColor, alpha);
        }
      `,
      transparent: true,
      depthWrite: false,
      blending: THREE.AdditiveBlending
    });

    const points = new THREE.Points(geo, material);
    scene.add(points);

    // --- BLOOM (LOWERED STRENGTH) ---
    const composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
    bloom.threshold = 0.2;
    bloom.strength = 0.6; // Much lower brightness
    bloom.radius = 0.5;
    composer.addPass(bloom);
    composer.addPass(new OutputPass());

    // --- INTERACTION ---
    const clock = new THREE.Clock();

    document.addEventListener('click', () => {
      material.uniforms.uClickTime.value = clock.getElapsedTime();
    });

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      material.uniforms.time.value = clock.getElapsedTime();
      composer.render();
    }
    animate();

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      composer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
