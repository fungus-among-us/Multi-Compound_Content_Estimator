<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <style>
    body { margin: 0; overflow: hidden; background: #000; }
    canvas { display: block; width: 100vw; height: 100vh; }
  </style>
</head>
<body>
  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.181.0/build/three.webgpu.js";
    import { TSL as $ } from "https://unpkg.com/three@0.181.0/build/three.tsl.js";
    import { OrbitControls } from "https://unpkg.com/three@0.181.0/examples/jsm/controls/OrbitControls.js";

    // Parse Speed from URL
    const urlParams = new URLSearchParams(window.location.search);
    const speedMult = parseFloat(urlParams.get('speed')) || 1.0;

    const renderer = await new THREE.WebGPURenderer({ antialias: true }).init();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050505);

    const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 100);
    camera.position.set(5, 5, 5);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.autoRotate = true;
    controls.autoRotateSpeed = 2.0 * speedMult;

    // Lighting
    const light = new THREE.DirectionalLight(0xffffff, 4);
    light.position.set(2, 5, 2);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0x222222));

    // Boxes
    const count = 100;
    const geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
    const material = new THREE.MeshPhysicalNodeMaterial();

    // TSL Logic
    const time = $.time.mul(speedMult * 0.5);

    // Position Logic
    const i = $.instanceIndex.toFloat();
    const angle = i.mul(0.5).add(time);
    const radius = $.sin(i.mul(0.2).add(time)).mul(3).add(4);
    const x = $.cos(angle).mul(radius);
    const z = $.sin(angle).mul(radius);
    const y = $.sin(angle.mul(2)).mul(2);

    material.positionNode = $.vec3(x, y, z);

    // Color Logic (Slow Hue Cycle)
    const hue = time.mul(0.1).add(i.mul(0.01)).fract();
    material.colorNode = $.hsl(hue, 1.0, 0.5);

    const mesh = new THREE.InstancedMesh(geometry, material, count);
    scene.add(mesh);

    // Render
    renderer.setAnimationLoop(() => {
      controls.update();
      renderer.render(scene, camera);
    });

    window.addEventListener('resize', () => {
      renderer.setSize(window.innerWidth, window.innerHeight);
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
    });
  </script>
</body>
</html>
